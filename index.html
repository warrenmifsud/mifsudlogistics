<div id="mifsud-shipping-calculator">
  <div class="mifsud-bg"></div>
  <div class="mifsud-overlay"></div>

  

  <!-- ===== KPI / Info Boxes (safe to add more) ===== -->
  <section class="mifsud-kpis" aria-label="How it works">
    <div class="mifsud-kpis-title">How it works</div>
  <div class="mifsud-kpis-inner">
  
      <!-- KPI BOX (duplicate this .mifsud-kpi block to add more KPIs safely) -->
      <div class="mifsud-kpi mifsud-kpi-hover" tabindex="0" aria-label="Buy from Sicily">
      <div class="mifsud-kpi-tooltip">
        Buy from stores or websites in Sicily that do not ship directly to Malta.
      </div>
        <div class="mifsud-kpi-icon" aria-hidden="true">
          <!-- Simple inline icon -->
          <svg viewBox="0 0 24 24" width="18" height="18">
            <path fill="currentColor" d="M21 7.5 12 2 3 7.5V16.5L12 22l9-5.5V7.5zM12 4.3 18.6 8 12 11.7 5.4 8 12 4.3z"/>
          </svg>
        </div>
        <div class="mifsud-kpi-body">
          <div class="mifsud-kpi-title">Buy from Sicily</div>
          
        </div>
      </div>
  
      <!-- Add more KPI boxes by copying the .mifsud-kpi block above -->
  
    
    <div class="mifsud-kpi" role="button" tabindex="0" aria-label="Learn more: Sicily Hub Delivery Address" data-kpi="sicily-hub">
      <div class="mifsud-kpi-icon" aria-hidden="true">
        <svg viewBox="0 0 24 24" width="18" height="18">
          <path fill="currentColor" d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5A2.5 2.5 0 1 1 12 6.5a2.5 2.5 0 0 1 0 5z"/>
        </svg>
      </div>
      <div class="mifsud-kpi-body">
        <div class="mifsud-kpi-title">Sicily Hub Delivery Address</div>
        <div class="mifsud-kpi-text">Use our Sicily hub address at checkout.</div>
        
      </div>
    </div>

    <div class="mifsud-kpi" tabindex="0" aria-label="Deliver to Malta Hub">
      <div class="mifsud-kpi-icon" aria-hidden="true">
        <svg viewBox="0 0 24 24" width="18" height="18">
          <path fill="currentColor" d="M20 8h-3V4H7v4H4v12h16V8zm-9-2h2v2h-2V6zm7 12H6v-8h12v8z"/>
        </svg>
      </div>
      <div class="mifsud-kpi-body">
        <div class="mifsud-kpi-title">Deliver to Malta Hub</div>
        <div class="mifsud-kpi-text">We forward your package to our Malta hub.</div>
      </div>
    </div>

    <div class="mifsud-kpi" tabindex="0" aria-label="Deliver to your address">
      <div class="mifsud-kpi-icon" aria-hidden="true">
        <svg viewBox="0 0 24 24" width="18" height="18">
          <path fill="currentColor" d="M12 3 2 12h3v7h6v-5h2v5h6v-7h3L12 3z"/>
        </svg>
      </div>
      <div class="mifsud-kpi-body">
        <div class="mifsud-kpi-title">Deliver to your address</div>
        <div class="mifsud-kpi-text">Choose final delivery to your door.</div>
      </div>
    </div>
</div>
  </section>

<div class="mifsud-headline">
    Shop and Drop to our warehouse.
  </div>

  <div class="mifsud-card">
    <div class="mifsud-panel">

      <!-- STEP 1 -->
      <div class="mifsud-step active" id="step1">
        <h3>Shipping Calculator</h3>

        <label>Ship from</label>
        <div class="row routeRow">
          <div class="fromFixed">Sicily</div>
          <div class="between">to</div>
          <select id="to">
            <option value="Malta">Malta</option>
            <option value="Gozo">Gozo</option>
          </select>
        </div>

        <button class="primary" id="next" type="button">Proceed</button>
      </div>

      <!-- STEP 1B (SERVICE SELECTION) -->
      <div class="mifsud-step" id="step1b">
        <h3>Select Service</h3>

        <label>Choose delivery type *</label>
        <div class="mifsud-choice">

          <!-- PACKAGE (single selectable option) -->
          <label class="mifsud-choice-item mifsud-package-item">
            <input type="radio" name="serviceType" value="package" checked>
            <div>
              <div class="mifsud-choice-title">Package</div>
              <div class="mifsud-choice-sub">30kg max weight</div>

              <!-- Subheading (NOT selectable) -->
              <div class="mifsud-package-info" aria-hidden="true">
                <div> Small Package</div>
                <div> Medium Package</div>
                <div> Large Package</div>
              </div>
            </div>
          </label>

          <!-- PALLET -->
          <label class="mifsud-choice-item">
            <input type="radio" name="serviceType" value="pallet">
            <div>
              <div class="mifsud-choice-title">Pallet Delivery</div>
              <div class="mifsud-choice-sub">Up to 120x80x200cm Â· &#8364;200 fixed</div>
            </div>
          </label>

        </div>

        <div class="row">
          <button class="ghost" id="backToStep1" type="button">Back</button>
          <button class="primary" id="next2" type="button">Proceed</button>
        </div>
      </div>

      <!-- STEP 2 (MEASUREMENTS + PRICE ONLY) -->
      <div class="mifsud-step" id="step2">
        <h3>Package Details</h3>

        <!-- âœ… Quantity + Weight on the same row -->
        <div class="row qtyWeightRow">
          <div>
            <label>Quantity</label>
            <input id="qty" type="number" step="1" min="1" value="1" placeholder="e.g. 1">
          </div>

          <div>
            <label>Weight (kg)</label>
            <input id="kg" type="number" step="0.1" min="0" placeholder="e.g. 12.5">
            <div id="kgWarn" class="kgWarn hidden"></div>
          </div>
        </div>

        <label>Dimensions (cm)</label>
        <div class="row dimsRow">
          <input id="w" type="number" step="0.1" min="0" placeholder="Width">
          <input id="l" type="number" step="0.1" min="0" placeholder="Length">
          <input id="h" type="number" step="0.1" min="0" placeholder="Height">
        </div>

        <div class="row">
          <button class="ghost" id="backToStep1b" type="button">Back</button>
          <button class="primary" id="calc" type="button">Calculate price</button>
        </div>

        <!-- Price (shown after successful calc) -->
        <div id="priceBox" class="result hidden"></div>

        <button class="primary" id="toContact" type="button" disabled>Proceed</button>
      </div>

      <!-- STEP 3 (CONTACT + SUBMIT ONLY) -->
      <div class="mifsud-step" id="step3">
        <h3>Contact Details</h3>

        <label>Customer name *</label>
        <input id="name" type="text" placeholder="Full name" required>

        <label>E-mail address *</label>
        <input id="email" type="email" placeholder="name@example.com" required>

        <label>Delivery address</label>
        <input id="addr" type="text" placeholder="Street, locality, postcode">

        <div class="row">
          <button class="ghost" id="backToMeasures" type="button">Back</button>
        </div>

        <!-- Final summary + confirm + submit -->
        <div id="result" class="result hidden"></div>
      </div>

    </div>
  </div>
</div>

<style>
  #mifsud-shipping-calculator{
    position: relative;
    width: 100%;
    min-height: 100vh;   /* fallback */
    min-height: 100svh;  /* iOS Safari visible viewport */
    min-height: 100dvh;  /* dynamic viewport */
    margin: 0;
    padding: calc(env(safe-area-inset-top) + 24px) 16px calc(env(safe-area-inset-bottom) + 24px);
    overflow: hidden;
    font-family: system-ui, Arial, sans-serif;

    /* Center content */
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}


  #mifsud-shipping-calculator .mifsud-bg{
    position:fixed; inset:0;
    background:url("https://cdn.shopify.com/s/files/1/0997/7852/7577/files/Golden_Hour_Shipping_Containers_on_Dock-12.png?v=1767542496")
      center/cover no-repeat;
  }
  #mifsud-shipping-calculator .mifsud-overlay{
    position:fixed; inset:0;
    backdrop-filter:blur(10px);
    -webkit-backdrop-filter:blur(10px);
    background:rgba(0,0,0,.25);
  }

  .mifsud-headline{
    position:relative; z-index:2;
    text-align:center;
    color:#fff;
    font-weight:700;
    font-size:28px;
    margin-bottom:40px;
    text-shadow:0 6px 18px rgba(0,0,0,.45);
    padding:0 10px;
  }

  .mifsud-card{
    position:relative; z-index:2;
    max-width:720px;
    margin:0 auto;
    background:rgba(255,255,255,.15);
    border-radius:22px;
    padding:14px;
    box-shadow:0 18px 60px rgba(0,0,0,0.25);
  }
  .mifsud-panel{
    background:rgba(235,235,235,.92);
    border-radius:16px;
    padding:16px;
  }

  h3{margin:0 0 10px;color:#111}

  label{font-size:13px;font-weight:600;margin-top:12px;display:block;color:#111}
  input,select{
    width:100%;
    padding:12px;
    border-radius:12px;
    border:1px solid rgba(0,0,0,.15);
    background:#e3e3e3;
    font-size:14px;
    color:#111;
  }

  .row{display:grid;gap:10px}
  .routeRow{grid-template-columns:1fr auto 1fr;align-items:center}
  .dimsRow{grid-template-columns:repeat(3,1fr)}

  /* âœ… Quantity + Weight row */
  .qtyWeightRow{grid-template-columns:1fr 1fr;align-items:start}

  .fromFixed{
    padding:12px;
    background:#e3e3e3;
    border-radius:12px;
    border:1px solid rgba(0,0,0,.15)
  }
  .between{text-align:center;font-weight:600;color:#111}

  button{
    margin-top:14px;
    padding:12px;
    border-radius:12px;
    border:none;
    cursor:pointer;
    font-size:14px;
  }
  .primary{background:#2a2a2a;color:#fff}
  .ghost{background:transparent;border:1px solid #aaa;color:#333}

  .mifsud-step{display:none}
  .mifsud-step.active{display:block}

  .result{
    margin-top:16px;
    padding:14px;
    background:rgba(235,235,235,.95);
    border-radius:12px;
    border:1px solid rgba(0,0,0,.12);
  }
  .result.hidden{display:none}
  .result.error{
    background:rgba(255,235,235,.95);
    border-color:rgba(155,28,28,.25);
    color:#9b1c1c;
    font-weight:600;
  }

  /* Pallet badge */
  .mifsud-badge{
    display:inline-flex;
    align-items:center;
    gap:6px;
    padding:6px 10px;
    border-radius:999px;
    border:1px solid rgba(0,0,0,.18);
    background:rgba(255,255,255,.85);
    color:#111;
    font-size:12px;
    font-weight:800;
    letter-spacing:.2px;
    margin-bottom:10px;
  }
  .mifsud-badge .dot{
    width:8px;
    height:8px;
    border-radius:50%;
    background:#111;
    display:inline-block;
  }

  /* Service type choices */
  .mifsud-choice{
    display:grid;
    gap:10px;
    margin-top:10px;
  }
  .mifsud-choice-item{
    display:flex;
    gap:10px;
    align-items:flex-start;
    padding:12px;
    border-radius:14px;
    border:1px solid rgba(0,0,0,.15);
    background:#e3e3e3;
    cursor:pointer;
  }
  .mifsud-choice-item input{
    width:18px;
    height:18px;
    margin-top:2px;
    accent-color:#111;
  }
  .mifsud-choice-title{
    font-weight:900;
    color:#111;
    font-size:14px;
    line-height:1.1;
  }
  .mifsud-choice-sub{
    font-size:12px;
    color:rgba(0,0,0,.7);
    margin-top:2px;
  }

  /* Package info auto-expand on hover / focus */
  .mifsud-package-info{
    margin-top:6px;
    font-size:12px;
    color:rgba(0,0,0,.65);
    line-height:1.35;

    max-height:0;
    opacity:0;
    overflow:hidden;
    transform:translateY(-2px);
    transition:max-height .25s ease, opacity .2s ease, transform .25s ease;
  }
  .mifsud-package-item:hover .mifsud-package-info,
  .mifsud-package-item:focus-within .mifsud-package-info{
    max-height:80px;
    opacity:1;
    transform:translateY(0);
  }

  /* Live 30kg warning */
  .kgWarn{
    margin-top:8px;
    padding:10px 12px;
    border-radius:12px;
    border:1px solid rgba(155,28,28,.25);
    background:rgba(255,235,235,.95);
    color:#9b1c1c;
    font-weight:700;
    font-size:13px;
  }
  .kgWarn.hidden{display:none}

  .confirm{margin-top:12px}
  .confirm label{
    display:flex;
    gap:10px;
    align-items:flex-start;
    font-size:13px;
    font-weight:600;
    color:#111;
    cursor:pointer;
  }
  .confirm input[type="checkbox"]{
    appearance:auto;
    -webkit-appearance:checkbox;
    width:18px;
    height:18px;
    margin-top:2px;
    accent-color:#111;
    background:#fff;
    border:1px solid rgba(0,0,0,.35);
    border-radius:4px;
  }

  .result button{width:100%}
  button:disabled{opacity:.55;cursor:not-allowed}

  @media(max-width:600px){
    .dimsRow,.routeRow,.qtyWeightRow{grid-template-columns:1fr}
    .mifsud-headline{font-size:22px}
  }

/* ðŸ“¦ Box icon next to Package title (CSS-only, no HTML changes) */
.mifsud-package-item .mifsud-choice-title::before {
  content: "";
  display: inline-block;
  width: 16px;
  height: 16px;
  margin-right: 6px;
  transform: translateY(1px);
  background-repeat: no-repeat;
  background-size: contain;
  filter: drop-shadow(0 1px 1px rgba(0,0,0,.35));
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0' y1='0' x2='0' y2='1'%3E%3Cstop offset='0%25' stop-color='%23333'/%3E%3Cstop offset='100%25' stop-color='%23000'/%3E%3C/linearGradient%3E%3C/defs%3E%3Cpath fill='url(%23g)' d='M21 7.5 12 2 3 7.5V16.5L12 22l9-5.5V7.5zM12 4.3 18.6 8 12 11.7 5.4 8 12 4.3zM5 9.4 11 13v6.2l-6-3.7V9.4zm14 0v6.1L13 19.2V13l6-3.6z'/%3E%3C/svg%3E");
}


/* ===== Package Details layout refinement (CSS ONLY) ===== */

/* Reorder fields: Dimensions above Quantity/Weight */
#step2 .dimsRow {
  order: 1;
}

#step2 .qtyWeightRow {
  order: 2;
}

/* Reduce spacing between rows */
#step2 .row {
  gap: 8px;
}

/* Tighten input fields */
#step2 input {
  padding: 10px 12px;
  font-size: 13px;
  border-radius: 10px;
}

/* Slightly tighter labels */
#step2 label {
  margin-top: 10px;
  font-size: 12px;
}

/* Compact dimensions inputs */
#step2 .dimsRow input {
  padding: 9px 10px;
}

/* Compact quantity/weight inputs */
#step2 .qtyWeightRow input {
  padding: 9px 10px;
}


/* ===== SAFE: Dimensions ABOVE Quantity/Weight (STEP 2 ONLY) ===== */

/* Use grid ordering only inside Step 2 panel flow */
#step2 .dimsRow {
  margin-top: 0;
}

#step2 .qtyWeightRow {
  margin-top: 12px;
}

/* Move Dimensions block visually above Quantity/Weight */
#step2 .dimsRow {
  grid-row: 1;
}

#step2 .qtyWeightRow {
  grid-row: 2;
}


/* ===== STEP 2 ONLY: Dimensions ABOVE Quantity/Weight (no HTML/JS changes) ===== */
/* Use grid ONLY when Step 2 is active, so other steps remain unchanged */
#step2.mifsud-step.active{
  display:grid;           /* overrides .mifsud-step.active{display:block} safely */
  grid-template-columns: 1fr;
  row-gap: 0;
}

/* Place Step 2 direct children into explicit rows */
#step2 > h3{ grid-row: 1; }
#step2 > label{ grid-row: 2; }              /* "Dimensions (cm)" label (only top-level label in step2) */
#step2 > .dimsRow{ grid-row: 3; }
#step2 > .qtyWeightRow{ grid-row: 4; }
#step2 > .row:not(.dimsRow):not(.qtyWeightRow){ grid-row: 5; }
#step2 > #priceBox{ grid-row: 6; }
#step2 > #toContact{ grid-row: 7; }


/* ===== STEP 2 ONLY: Compact dimension input widths (CSS ONLY) ===== */
#step2 .dimsRow{
  grid-template-columns: repeat(3, max-content);
  column-gap: 8px;
}

#step2 .dimsRow input{
  width: 90px;          /* compact width */
  max-width: 100%;
  text-align: center;
}


/* ===== STEP 2 ONLY: Compact Quantity & Weight inputs (CSS ONLY) ===== */
#step2 .qtyWeightRow{
  grid-template-columns: max-content max-content;
  column-gap: 12px;
}

#step2 .qtyWeightRow input{
  width: 90px;
  max-width: 100%;
  text-align: center;
}


/* ===== STEP 2 ONLY: Inline Dimensions + Quantity + Weight (CSS ONLY) ===== */

/* Make a single inline grid */
#step2 .dimsRow{
  display:grid;
  grid-template-columns: repeat(5, max-content);
  column-gap: 10px;
  align-items: end;
}

/* Move qty & weight into same visual row */
#step2 .qtyWeightRow{
  display: contents;
}

/* Keep compact sizing */
#step2 .dimsRow input,
#step2 .qtyWeightRow input{
  width: 90px;
  text-align: center;
}


/* ===== STEP 2 ONLY: INLINE (Dimensions + Qty/Weight side-by-side) â€” FIXED (CSS ONLY) ===== */
/* Overrides previous inline attempt safely without touching HTML/JS */

/* Step 2 layout: 2 columns for the measurement line */
#step2.mifsud-step.active{
  display:grid;
  grid-template-columns: auto auto;
  column-gap: 14px;
  align-items:start;
}

/* Headline spans full width */
#step2 > h3{
  grid-column: 1 / -1;
  grid-row: 1;
}

/* "Dimensions (cm)" label spans full width (kept as-is) */
#step2 > label{
  grid-column: 1 / -1;
  grid-row: 2;
}

/* Place Dimensions inputs left, Qty/Weight right on the same line */
#step2 > .dimsRow{
  grid-column: 1;
  grid-row: 3;
}
#step2 > .qtyWeightRow{
  grid-column: 2;
  grid-row: 3;
}

/* Keep buttons & below content full width underneath */
#step2 > .row:not(.dimsRow):not(.qtyWeightRow){
  grid-column: 1 / -1;
  grid-row: 4;
}
#step2 > #priceBox{
  grid-column: 1 / -1;
  grid-row: 5;
}
#step2 > #toContact{
  grid-column: 1 / -1;
  grid-row: 6;
}

/* Ensure both groups stay compact and aligned */
#step2 .dimsRow{
  display:grid; /* override any previous display/grid settings */
  grid-template-columns: repeat(3, max-content);
  column-gap: 8px;
  align-items:end;
}
#step2 .qtyWeightRow{
  display:grid; /* override display: contents from previous attempt */
  grid-template-columns: repeat(2, max-content);
  column-gap: 12px;
  align-items:end;
  margin-top: 0; /* remove extra spacing */
}

/* Keep compact widths */
#step2 .dimsRow input,
#step2 .qtyWeightRow input{
  width: 90px;
  max-width: 100%;
  text-align: center;
}

/* Mobile: stack nicely */
@media(max-width:600px){
  #step2.mifsud-step.active{
    grid-template-columns: 1fr;
    row-gap: 10px;
  }
  #step2 > .dimsRow{ grid-column: 1; grid-row: 3; }
  #step2 > .qtyWeightRow{ grid-column: 1; grid-row: 4; }
  #step2 > .row:not(.dimsRow):not(.qtyWeightRow){ grid-row: 5; }
  #step2 > #priceBox{ grid-row: 6; }
  #step2 > #toContact{ grid-row: 7; }
}


/* ===== STEP 2 ONLY: Professional alignment for inline inputs (CSS ONLY) ===== */
/* Make qty/weight labels not affect input alignment while staying visible */
#step2 > .qtyWeightRow > div{
  position: relative;
  padding-top: 16px; /* reserves space for the label without pushing the input down inconsistently */
}

/* Place the labels in the reserved space (no layout shift) */
#step2 > .qtyWeightRow > div > label{
  position: absolute;
  top: 0;
  left: 0;
  margin: 0;
  height: 14px;
  line-height: 14px;
  font-size: 12px;
}

/* Match dimsRow vertical position with qty/weight inputs */
#step2 > .dimsRow{
  padding-top: 16px; /* same reserved label space so all inputs line up */
  align-items: end;
}

/* Ensure both groups share identical input height and baseline */
#step2 .dimsRow input,
#step2 .qtyWeightRow input{
  height: 40px;
  padding: 9px 10px;
  box-sizing: border-box;
}

/* Tighten overall line so it looks crisp */
#step2 > .dimsRow,
#step2 > .qtyWeightRow{
  align-self: start;
}


/* ===== Smooth entrance animation (CSS ONLY) ===== */
@keyframes mifsudFadeUp {
  from { opacity: 0; transform: translateY(22px); }
  to   { opacity: 1; transform: translateY(0); }
}

/* Animate headline + card on first paint */
.mifsud-headline,
.mifsud-card{
  animation: mifsudFadeUp 650ms ease-out both;
}

/* Slight stagger so headline appears first */
.mifsud-card{ animation-delay: 120ms; }

/* Accessibility: respect reduced motion */
@media (prefers-reduced-motion: reduce){
  .mifsud-headline,
  .mifsud-card{
    animation: none !important;
    opacity: 1 !important;
    transform: none !important;
  }
}


/* ===== Mobile enhancement: make calculator feel larger ===== */

@media (max-width: 600px){

  /* Give card more presence */
  .mifsud-card{
    width: 100%;
    max-width: 520px;  /* keeps it feeling "big" but not edge-to-edge on tiny screens */
    transform: translateY(18px); /* slightly lowered */
  }

  /* Reduce side padding so card fills screen */
  #mifsud-shipping-calculator{
    padding: calc(env(safe-area-inset-top) + 18px) 10px calc(env(safe-area-inset-bottom) + 18px);
  }

  /* Make headline feel like a hero */
  .mifsud-headline{
    font-size: 24px;
    margin-bottom: 18px;
    padding: 0 6px;
  }

  /* Increase input & button size for touch */
  input,
  select,
  button{
    font-size: 16px; /* prevents iOS zoom */
    padding: 14px;
  }

  button{
    padding: 15px;
  }

  /* Reduce inner panel padding so content breathes */
  .mifsud-panel{
    padding: 14px;
  }
}


/* ===== MOBILE-FIRST OVERRIDES (desktop untouched) ===== */
@media (max-width: 600px){

  /* Make the calculator the hero on mobile */
  #mifsud-shipping-calculator{
    justify-content: flex-start !important; /* avoids tiny floating center */
    padding-top: calc(env(safe-area-inset-top) + 40px) !important;
    padding-bottom: calc(env(safe-area-inset-bottom) + 40px) !important;
    padding-left: 10px !important;
    padding-right: 10px !important;
  }

  /* Big, confident card */
  .mifsud-card{
    width: 94vw !important;      /* near full-width */
    max-width: 94vw !important;  /* override desktop cap */
    padding: 14px !important;
    transform: translateY(18px) !important;
  }

  .mifsud-panel{
    padding: 18px !important;
  }

  /* Headline scales nicely */
  .mifsud-headline{
    font-size: 24px !important;
    line-height: 1.25 !important;
    margin-bottom: 22px !important;
    padding: 0 10px !important;
  }

  /* Touch-friendly inputs/buttons (also prevents iOS zoom) */
  input, select{
    font-size: 16px !important;
    padding: 14px !important;
    border-radius: 14px !important;
  }

  button{
    font-size: 16px !important;
    padding: 15px !important;
    border-radius: 14px !important;
  }

  /* Keep the route row usable on narrow screens */
  .routeRow{
    grid-template-columns: 1fr auto 1fr !important;
  }
}

/* ===== Desktop lock (optional safety) ===== */
@media (min-width: 601px){
  .mifsud-card{
    max-width: 720px;
  }
}


/* ===== DESKTOP ENHANCEMENT (mobile untouched) ===== */
@media (min-width: 900px){

  /* Wider, more professional desktop card */
  .mifsud-card{
    max-width: 880px;          /* wider than before */
    padding: 18px;
  }

  .mifsud-panel{
    padding: 22px;
  }

  /* Slightly stronger headline presence */
  .mifsud-headline{
    font-size: 30px;
    margin-bottom: 36px;
  }

  /* Improve spacing rhythm on desktop */
  input,
  select{
    padding: 13px 14px;
    font-size: 15px;
  }

  button{
    padding: 13px 16px;
    font-size: 15px;
  }
}


/* ===== DESKTOP: EXTRA-WIDE PROFESSIONAL LAYOUT ===== */
@media (min-width: 1100px){

  .mifsud-card{
    max-width: 1040px;   /* noticeably wider */
    padding: 22px;
  }

  .mifsud-panel{
    padding: 26px;
  }

  /* Inputs breathe more on large screens */
  .dimsRow,
  .qtyWeightRow{
    column-gap: 14px;
  }

  input,
  select{
    padding: 14px 16px;
    font-size: 15px;
  }

  button{
    padding: 14px 18px;
    font-size: 15px;
  }
}

/* Ultra-wide screens (large monitors) */
@media (min-width: 1400px){
  .mifsud-card{
    max-width: 1120px;
  }
}


/* ===== DESKTOP: TRUE WIDTH EXPANSION (not padding) ===== */
@media (min-width: 900px){

  /* Make calculator span the viewport, not a card width */
  .mifsud-card{
    width: 90vw;           /* REAL width expansion */
    max-width: 1200px;     /* professional cap */
    margin-left: auto;
    margin-right: auto;
  }
}

/* Very large screens */
@media (min-width: 1400px){
  .mifsud-card{
    width: 85vw;
    max-width: 1400px;
  }
}


/* ===== DESKTOP: SLIGHTLY NARROWER (balanced) ===== */
@media (min-width: 900px){
  .mifsud-card{
    width: 82vw;          /* reduced from 90vw */
    max-width: 1180px;    /* refined professional cap */
  }
}

@media (min-width: 1400px){
  .mifsud-card{
    width: 76vw;          /* avoids over-stretch on big monitors */
    max-width: 1280px;
  }
}


/* ===== DESKTOP: FURTHER NARROWED (clean & professional) ===== */
@media (min-width: 900px){
  .mifsud-card{
    width: 74vw;          /* narrower than before */
    max-width: 1080px;    /* strong professional cap */
  }
}

@media (min-width: 1400px){
  .mifsud-card{
    width: 68vw;          /* keeps ultra-wide screens elegant */
    max-width: 1180px;
  }
}


/* STEP 2: Hide Proceed button until price is calculated */
#step2 #toContact{
  display: none;
}


/* ===== MOBILE: TONE DOWN BACKGROUND SCALE ===== */
@media (max-width: 600px){

  /* Reduce visual dominance of background image */
  #mifsud-shipping-calculator .mifsud-bg{
    background-size: 120% auto;   /* was cover â†’ now calmer */
    background-position: center 35%;
    transform: scale(1);          /* ensure no extra zoom */
  }

  /* Slightly strengthen overlay so bg feels softer */
  #mifsud-shipping-calculator .mifsud-overlay{
    background: rgba(0,0,0,0.32);
  }
}


/* ===== MOBILE (STEP 1): Ship from on one line, Ship to below ===== */
@media (max-width: 600px){

  /* Step 1 route layout: "Sicily" row, then dropdown below */
  #step1 .routeRow{
    display: grid !important;
    grid-template-columns: 1fr !important;
    grid-template-areas:
      "from"
      "to";
    gap: 10px !important;
    align-items: stretch !important;
  }

  #step1 .fromFixed{
    grid-area: from;
    display: flex;
    align-items: center;
    gap: 10px;
    font-weight: 700;
  }

  /* Inline "Ship from" label inside the Sicily field (mobile only) */
  #step1 .fromFixed::before{
    content: "Ship from:";
    font-weight: 800;
    color: rgba(0,0,0,.75);
  }

  /* Hide the tiny "to" separator on mobile */
  #step1 .between{
    display: none !important;
  }

  #step1 #to{
    grid-area: to;
    width: 100% !important;
  }

  /* Add a "Ship to" label right above the dropdown (mobile only) */
  #step1 #to{
    margin-top: 0;
  }
  #step1 .routeRow::after{
    content: "Ship to";
    grid-area: to;
    align-self: start;
    justify-self: start;
    font-size: 13px;
    font-weight: 700;
    color: #111;
    margin-bottom: -6px;
  }

  /* Because ::after shares the same grid area, give the select a bit of top space */
  #step1 #to{
    margin-top: 16px;
  }
}




/* ===== KPI / Info Boxes (TOP, hoverable, safe to extend) ===== */
.mifsud-kpis{
  position: relative;
  z-index: 2; /* above background layers */
  width: 100%;
  max-width: 1280px;
  margin: 0 auto 18px;
  padding: 0 16px;
}

.mifsud-kpis-inner{
  width: 100%;
  display: grid;
  grid-template-columns: repeat(3, minmax(0, 1fr));
  gap: 14px;
}

/* KPI Card */
.mifsud-kpi{
  display: flex;
  gap: 12px;
  align-items: flex-start;
  background: rgba(235,235,235,.92);
  border: 1px solid rgba(0,0,0,.10);
  border-radius: 18px;
  padding: 16px;
  box-shadow: 0 10px 26px rgba(0,0,0,.08);

  cursor: pointer;
  user-select: none;
  transition: transform .18s ease, box-shadow .18s ease, background-color .18s ease, border-color .18s ease;
}

/* Hover / Focus / Active */
.mifsud-kpi:hover{
  transform: translateY(-3px);
  box-shadow: 0 16px 38px rgba(0,0,0,.14);
  background: rgba(245,245,245,.96);
  border-color: rgba(0,0,0,.14);
}

.mifsud-kpi:active{
  transform: translateY(-1px);
}

.mifsud-kpi:focus-visible{
  outline: 3px solid rgba(0,0,0,.28);
  outline-offset: 3px;
}

.mifsud-kpi-icon{
  width: 38px;
  height: 38px;
  border-radius: 14px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  background: rgba(0,0,0,.10);
  color: #111;
  flex: 0 0 auto;
}

.mifsud-kpi-title{
  font-weight: 900;
  color: #111;
  font-size: 14px;
  line-height: 1.2;
}

.mifsud-kpi-text{
  margin-top: 4px;
  color: rgba(0,0,0,.72);
  font-size: 13px;
  line-height: 1.45;
}

/* Responsive */
@media (max-width: 900px){
  .mifsud-kpis-inner{ grid-template-columns: 1fr 1fr; }
}
@media (max-width: 600px){
  .mifsud-kpis{
    padding: 0 10px;
    margin-bottom: 14px;
  }
  .mifsud-kpis-inner{ grid-template-columns: 1fr; }
}


/* ===== KPI refinement: narrower, softer, spaced ===== */
.mifsud-kpis{
  margin-bottom: 28px; /* space below KPI block */
}

.mifsud-kpis-inner{
  max-width: 960px;      /* narrow KPI container */
  margin: 0 auto;
}

/* Softer KPI cards */
.mifsud-kpi{
  background: rgba(235,235,235,.75); /* lower opacity */
  box-shadow: 0 8px 20px rgba(0,0,0,.06);
}

.mifsud-kpi:hover{
  background: rgba(245,245,245,.88);
  box-shadow: 0 14px 34px rgba(0,0,0,.12);
}


/* ===== Modal (clean & accessible) ===== */
.mifsud-modal{
  position: fixed;
  inset: 0;
  z-index: 999;
  display: none;
}

.mifsud-modal[aria-hidden="false"]{
  display: block;
}

.mifsud-modal-backdrop{
  position: absolute;
  inset: 0;
  background: rgba(0,0,0,.45);
}

.mifsud-modal-dialog{
  position: relative;
  max-width: 420px;
  margin: 12vh auto;
  background: rgba(245,245,245,.98);
  border-radius: 20px;
  padding: 22px;
  box-shadow: 0 30px 80px rgba(0,0,0,.35);
}

.mifsud-modal-dialog h3{
  margin-top: 0;
}

.mifsud-modal-dialog p{
  font-size: 14px;
  color: rgba(0,0,0,.75);
  line-height: 1.5;
}


/* ===== KPI Hover Description ===== */
.mifsud-kpi-hover{
  position: relative;
}

.mifsud-kpi-tooltip{
  position: absolute;
  left: 50%;
  bottom: calc(100% + 12px);
  transform: translateX(-50%);
  min-width: 240px;
  max-width: 300px;
  background: rgba(20,20,20,.92);
  color: #fff;
  font-size: 13px;
  line-height: 1.45;
  padding: 12px 14px;
  border-radius: 12px;
  box-shadow: 0 18px 40px rgba(0,0,0,.35);
  opacity: 0;
  pointer-events: none;
  transition: opacity .18s ease, transform .18s ease;
  transform-origin: bottom center;
  z-index: 10;
}

.mifsud-kpi-hover:hover .mifsud-kpi-tooltip,
.mifsud-kpi-hover:focus-within .mifsud-kpi-tooltip{
  opacity: 1;
  transform: translateX(-50%) translateY(-4px);
}

/* Small arrow */
.mifsud-kpi-tooltip::after{
  content: "";
  position: absolute;
  top: 100%;
  left: 50%;
  transform: translateX(-50%);
  border-width: 6px;
  border-style: solid;
  border-color: rgba(20,20,20,.92) transparent transparent transparent;
}

/* Mobile: show tooltip below card */
@media (max-width: 600px){
  .mifsud-kpi-tooltip{
    left: 50%;
    top: calc(100% + 10px);
    bottom: auto;
    transform: translateX(-50%);
  }
  .mifsud-kpi-tooltip::after{
    top: auto;
    bottom: 100%;
    border-color: transparent transparent rgba(20,20,20,.92) transparent;
  }
}


/* ===== KPI opacity + title alignment ===== */

/* Slightly higher opacity but still soft */
.mifsud-kpi{
  background: rgba(235,235,235,.82);
}

/* Align icon + title nicely */
.mifsud-kpi-body{
  display: flex;
  align-items: center; /* vertical alignment */
}

/* Make title align with icon center */
.mifsud-kpi-title{
  margin: 0;
  line-height: 1.3;
}


/* ===== KPI title fine alignment fix ===== */
.mifsud-kpi-body{
  align-items: center;
}

.mifsud-kpi-title{
  position: relative;
  top: 1px; /* micro-adjust to perfectly center with icon */
}


/* ===== KPI title final optical centering ===== */
.mifsud-kpi{
  align-items: center; /* ensure icon + text align on same centerline */
}

.mifsud-kpi-title{
  position: relative;
  top: 2px; /* final optical correction */
}


/* ===== KPI width refinement ===== */
.mifsud-kpis-inner{
  max-width: 820px;   /* narrower container for KPIs */
  gap: 12px;
}

.mifsud-kpi{
  padding: 14px 16px; /* slightly tighter */
}

/* Desktop: keep them compact */
@media (min-width: 900px){
  .mifsud-kpis-inner{
    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
  }
}


/* ===== KPI boxes: truly narrower pills ===== */
.mifsud-kpis-inner{
  max-width: 640px;              /* constrain group */
  justify-content: center;
}

.mifsud-kpi{
  max-width: 300px;              /* cap each KPI box */
  width: auto;
  margin: 0 auto;
  padding: 12px 16px;
}

/* Ensure they don't stretch in grid */
@media (min-width: 700px){
  .mifsud-kpis-inner{
    grid-template-columns: repeat(2, auto);
  }
}


/* ===== KPI grid adjustment for 3 pills ===== */
@media (min-width: 900px){
  .mifsud-kpis-inner{
    grid-template-columns: repeat(3, auto);
    max-width: 960px;
  }
}


/* ===== KPI grid adjustment for 4 pills ===== */
@media (min-width: 1100px){
  .mifsud-kpis-inner{
    grid-template-columns: repeat(4, auto);
    max-width: 1180px;
  }
}


/* ===== MOBILE BACKGROUND FIT FIX ===== */
@media (max-width: 600px){
  #mifsud-shipping-calculator .mifsud-bg{
    background-size: cover;      /* ensure it fits screen */
    background-position: center center;
    background-repeat: no-repeat;
  }

  /* Reduce perceived height so bg doesn't feel oversized */
  #mifsud-shipping-calculator{
    min-height: 90svh;
  }
}


/* ===== KPI: Mobile "How it works" layout ===== */
.mifsud-kpis-title{
  display: none;
  font-weight: 900;
  color: #111;
  margin: 0 auto 10px;
  max-width: 1180px;
  padding: 0 16px;
  font-size: 14px;
  letter-spacing: .2px;
}

.mifsud-kpi-text{
  display: none; /* keep desktop pills clean */
  margin-top: 3px;
  font-size: 12px;
  color: rgba(0,0,0,.68);
  line-height: 1.35;
}

@media (max-width: 600px){
  .mifsud-kpis{
    margin-bottom: 18px;
  }

  .mifsud-kpis-title{
    display: block;
    padding: 0 10px;
  }

  .mifsud-kpis-inner{
    max-width: 520px;
    grid-template-columns: 1fr !important;
    gap: 10px;
    padding: 0 10px;
    margin: 0 auto;
    counter-reset: kpiStep;
  }

  .mifsud-kpi{
    max-width: none;
    width: 100%;
    padding: 14px 14px 13px;
    border-radius: 16px;
    background: rgba(235,235,235,.78);
    box-shadow: 0 10px 24px rgba(0,0,0,.08);
    position: relative;
  }

  /* Step number badge */
  .mifsud-kpi::before{
    counter-increment: kpiStep;
    content: counter(kpiStep);
    position: absolute;
    top: 12px;
    right: 12px;
    width: 24px;
    height: 24px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 900;
    font-size: 12px;
    background: rgba(0,0,0,.12);
    color: #111;
  }

  .mifsud-kpi-icon{
    width: 34px;
    height: 34px;
    border-radius: 13px;
  }

  .mifsud-kpi-body{
    align-items: flex-start;
  }

  .mifsud-kpi-title{
    font-size: 14px;
  }

  .mifsud-kpi-text{
    display: block; /* show explanations on mobile */
  }

  /* Optional: reduce hover lift on touch devices */
  .mifsud-kpi:hover{
    transform: none;
  }
}

</style>

<script>
  (function(){
    const step1  = document.getElementById("step1");
    const step1b = document.getElementById("step1b");
    const step2  = document.getElementById("step2");
    const step3  = document.getElementById("step3");

    const nextBtn = document.getElementById("next");
    const backToStep1Btn = document.getElementById("backToStep1");
    const next2Btn = document.getElementById("next2");

    const backToStep1bBtn = document.getElementById("backToStep1b");
    const calcBtn = document.getElementById("calc");
    const toContactBtn = document.getElementById("toContact");

    const backToMeasuresBtn = document.getElementById("backToMeasures");

    const toEl    = document.getElementById("to");
    const qtyEl   = document.getElementById("qty");
    const wEl     = document.getElementById("w");
    const lEl     = document.getElementById("l");
    const hEl     = document.getElementById("h");
    const kgEl    = document.getElementById("kg");
    const kgWarn  = document.getElementById("kgWarn");

    const nameEl  = document.getElementById("name");
    const emailEl = document.getElementById("email");
    const addrEl  = document.getElementById("addr");

    const priceBox = document.getElementById("priceBox");
    const result   = document.getElementById("result");

    const SETTINGS = { emailTo: "mifsudlogistics@gmail.com", maxWeight: 70 };
    const PACKAGE_MAX_KG = 30;

    const STANDARD_SIZES = {
      small:  { a: 10, b: 40, c: 60, label: "Small â€” 10x40x60cm" },
      medium: { a: 20, b: 40, c: 60, label: "Medium â€” 20x40x60cm" },
      large:  { a: 40, b: 40, c: 60, label: "Large â€” 40x40x60cm" },
      pallet: { a: 80, b: 120, c: 200, label: "Pallet â€” 120x80x200cm" }
    };

    let serviceType = "package"; // "package" or "pallet"
    let userPickedService = false; // prevents auto-switch overriding manual choice
    let lastQuote = null;        // stores measurement + price result for step 3

    function go(from, to){
      from.classList.remove("active");
      to.classList.add("active");
    }

    nextBtn.onclick = () => go(step1, step1b);
    backToStep1Btn.onclick = () => go(step1b, step1);

    next2Btn.onclick = () => {
      const picked = document.querySelector('input[name="serviceType"]:checked');
      serviceType = picked ? picked.value : "package";
      go(step1b, step2);
      updateLiveHints();
    };

    backToStep1bBtn.onclick = () => go(step2, step1b);

    backToMeasuresBtn.onclick = () => {
      result.className = "result hidden";
      result.innerHTML = "";
      go(step3, step2);
      updateLiveHints();
    };

    function normalizeEmail(raw){
      return (raw || "").trim().toLowerCase();
    }

    function isValidEmail(email){
      return /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/i.test(email);
    }

    function customerIdFromEmail(email){
      let hash = 5381;
      for(let i=0;i<email.length;i++){
        hash = ((hash << 5) + hash) + email.charCodeAt(i);
        hash = hash | 0;
      }
      const positive = (hash >>> 0);
      return "MIF-" + positive.toString(36).toUpperCase();
    }

    function formatAddress(raw){
      if(!raw) return "";
      return raw
        .replace(/\s+/g," ")
        .replace(/\s*,\s*/g,", ")
        .trim()
        .split(",")
        .map(part => part.trim().split(" ").map(word =>
          /^\d/.test(word) ? word : word.charAt(0).toUpperCase()+word.slice(1).toLowerCase()
        ).join(" "))
        .join(", ");
    }

    function detectSizeBand(x,y,z){
      const dims=[x,y,z].map(Number).sort((a,b)=>a-b);
      if(dims.some(v=>!Number.isFinite(v)||v<=0)) return null;

      const fits=(std)=>{
        const s=[std.a,std.b,std.c].sort((a,b)=>a-b);
        return dims[0]<=s[0] && dims[1]<=s[1] && dims[2]<=s[2];
      };

      if(fits(STANDARD_SIZES.small)) return "small";
      if(fits(STANDARD_SIZES.medium)) return "medium";
      if(fits(STANDARD_SIZES.large)) return "large";

      // Pallet should not catch smaller boxes like 50x50x50
      if(fits(STANDARD_SIZES.pallet)){
        const maxSide = Math.max(dims[0], dims[1], dims[2]);
        if(maxSide > 60) return "pallet";
      }

      return "oversize";
    }

    function tier(band, weightKg){
      if(weightKg < 1 || weightKg > SETTINGS.maxWeight) return null;

      if(band==="small" || band==="medium"){
        if(weightKg<=10) return {type:"fixed", price:25.50};
        if(weightKg<=25) return {type:"fixed", price:40.00};
        if(weightKg<=30) return {type:"fixed", price:55.00};
        return {type:"request"};
      }

      if(band==="large"){
        if(weightKg<=25) return {type:"fixed", price:40.00};
        if(weightKg<=30) return {type:"fixed", price:55.00};
        return {type:"request"};
      }

      // Locked pallet price ONLY when it fits within 120x80x200cm (handled by detectSizeBand)
      if(band==="pallet"){
        return {type:"fixed", price:200.00};
      }

      if(band==="oversize") return {type:"request"};
      return null;
    }

    function showError(el, msg){
      el.className = "result error";
      el.innerHTML = msg;
      el.classList.remove("hidden");
    }

    function hideBox(el){
      el.className = "result hidden";
      el.innerHTML = "";
    }

    function setServiceType(nextType){
      serviceType = nextType;
      const target = document.querySelector(`input[name="serviceType"][value="${nextType}"]`);
      if(target) target.checked = true;
    }

    function updateLiveHints(){
      const w = Number(wEl.value);
      const l = Number(lEl.value);
      const h = Number(hEl.value);
      const weight = Number(kgEl.value);      // Auto-select pallet only if the user has NOT manually chosen a service (prevents "Package" feeling unclickable)
      if(!userPickedService && Number.isFinite(w) && Number.isFinite(l) && Number.isFinite(h) && w>0 && l>0 && h>0){
        const band = detectSizeBand(w,l,h);
        if(band === "pallet") setServiceType("pallet");
      }
      // Live warning: Package max 30kg
      if(serviceType === "package" && Number.isFinite(weight) && weight > PACKAGE_MAX_KG){
        kgWarn.className = "kgWarn";
        kgWarn.innerHTML = `Package service has a <strong>${PACKAGE_MAX_KG}kg</strong> max weight. Please choose <strong>Pallet Delivery</strong> or reduce the weight.`;
      }else{
        kgWarn.className = "kgWarn hidden";
        kgWarn.innerHTML = "";
      }
    }

    // Keep serviceType in sync if user changes selection manually (step 1b)
    document.querySelectorAll('input[name="serviceType"]').forEach(r => {
      r.addEventListener("change", () => {
        userPickedService = true;
        serviceType = r.value;
        updateLiveHints();
      });
    });

    // Live listeners (step 2)
    [wEl,lEl,hEl,kgEl].forEach(el => {
      el.addEventListener("input", updateLiveHints);
      el.addEventListener("change", updateLiveHints);
    });

    // Reset price/quote if measurement inputs change
    [toEl, qtyEl, wEl, lEl, hEl, kgEl].forEach(el => {
      el.addEventListener("input", () => {
        hideBox(priceBox);
        toContactBtn.disabled = true;
        toContactBtn.style.display = "none";
        lastQuote = null;
      });
      el.addEventListener("change", () => {
        hideBox(priceBox);
        toContactBtn.disabled = true;
        toContactBtn.style.display = "none";
        lastQuote = null;
      });
    });

    calcBtn.onclick = () => {
      hideBox(priceBox);

      const shipTo = toEl.value;
      const qty = Math.max(1, Math.floor(Number(qtyEl.value || 1)));
      qtyEl.value = String(qty);

      const w = Number(wEl.value);
      const l = Number(lEl.value);
      const h = Number(hEl.value);
      const weight = Number(kgEl.value);

      if(!Number.isFinite(qty) || qty < 1){
        return showError(priceBox, "<strong>Please enter a valid quantity (minimum 1).</strong>");
      }
      if(!Number.isFinite(w) || !Number.isFinite(l) || !Number.isFinite(h) || w<=0 || l<=0 || h<=0){
        return showError(priceBox, "<strong>Please enter valid dimensions (all must be greater than 0).</strong>");
      }
      if(!Number.isFinite(weight) || weight < 1){
        return showError(priceBox, "<strong>Please enter a valid weight (minimum 1kg).</strong>");
      }
      if(weight > SETTINGS.maxWeight){
        return showError(priceBox, `<strong>Maximum weight is ${SETTINGS.maxWeight}kg. For heavier items, please contact us.</strong>`);
      }
      if(serviceType === "package" && weight > PACKAGE_MAX_KG){
        return showError(priceBox, `<strong>Package service has a maximum weight of ${PACKAGE_MAX_KG}kg.</strong> Please choose Pallet Delivery or reduce the weight.`);
      }

      const band = detectSizeBand(w,l,h);
      if(!band){
        return showError(priceBox, "<strong>Unable to read parcel dimensions.</strong>");
      }

      // Enforce service choice
      let effectiveBand = band;
      if(serviceType === "package" && band === "pallet") effectiveBand = "oversize";
      if(serviceType === "pallet" && band !== "pallet") effectiveBand = "oversize";

      const sizeLabel = (effectiveBand==="oversize") ? "Oversize" : STANDARD_SIZES[effectiveBand].label;
      const dimsText = `${w.toFixed(1)}x${l.toFixed(1)}x${h.toFixed(1)} cm`;

      const t = tier(effectiveBand, weight);
      if(!t){
        return showError(priceBox, "<strong>Unable to calculate price.</strong>");
      }

      const isFixed = t.type === "fixed";
      const totalText = isFixed ? `&#8364;${(t.price * qty).toFixed(2)}` : "Price on request";
      const palletBadge = (effectiveBand === "pallet")
        ? `<div class="mifsud-badge"><span class="dot"></span> PALLET SERVICE</div>`
        : ``;

      priceBox.className = "result";
      priceBox.classList.remove("hidden");
      priceBox.innerHTML = `
        ${palletBadge}
        ${isFixed
          ? `<strong>Your shipping price is:</strong><div style="font-size:28px;font-weight:900;margin-top:6px;">${totalText}</div>`
          : `<strong>Price on request</strong>`}
        <div style="margin-top:10px;font-size:13px;line-height:1.35;text-align:left;color:rgba(0,0,0,.75)">
          <div><strong>Service Type:</strong> ${serviceType === "pallet" ? "Pallet Delivery" : "Package"}</div>
          <div>Ship from: <strong>Sicily</strong></div>
          <div>Ship to: <strong>${shipTo}</strong></div>
          <div><strong>Quantity:</strong> ${qty}</div>
          <div>Parcel Dimensions: ${dimsText}</div>
          <div>Size Category: ${sizeLabel}</div>
          <div>Weight: ${weight.toFixed(1)} kg</div>
        </div>
      `;

      lastQuote = {
        shipTo,
        qty,
        w, l, h,
        weight,
        band,
        effectiveBand,
        dimsText,
        sizeLabel,
        serviceType,
        isFixed,
        pricePerUnit: isFixed ? t.price : null,
        totalText
      };

      toContactBtn.disabled = false;
      toContactBtn.style.display = "block";
    };

    toContactBtn.onclick = () => {
      if(!lastQuote) return;
      hideBox(result);
      go(step2, step3);
      renderFinalSummary();
    };

    function buildMailto({ subject, customerId, name, email, address, quote }){
      const rawBody = `New Courier Quote Request

Service Type: ${quote.serviceType === "pallet" ? "Pallet Delivery" : "Package"}
Customer ID: ${customerId}
Customer: ${name}
E-mail: ${email}
Ship from: Sicily
Ship to: ${quote.shipTo}
Quantity: ${quote.qty}
Parcel Dimensions: ${quote.dimsText}
Size Category: ${quote.sizeLabel}
Weight: ${quote.weight.toFixed(1)} kg
Delivery Address: ${address}

Total Price: ${quote.totalText}

Client has agreed to the above details.`;
      // Mailto bodies are plain-text (not HTML). Normalize symbols to avoid entities/mojibake.
      const normalizedBody = rawBody
        .replace(/(&#8364;|â‚¬|Ã¢â€šÂ¬|Ã‚â‚¬)/g, 'EUR ')
        .replace(/(&#215;|Ã—|Ãƒâ€”)/g, 'x');
      const body = encodeURIComponent(normalizedBody);
      return `mailto:${SETTINGS.emailTo}?subject=${encodeURIComponent(subject)}&body=${body}`;
    }

    function renderFinalSummary(){
      if(!lastQuote){
        hideBox(result);
        return;
      }

      const name = (nameEl.value || "").trim();
      const email = normalizeEmail(emailEl.value);
      const address = formatAddress(addrEl.value || "");
      const canEmail = !!email && isValidEmail(email);

      const customerId = canEmail ? customerIdFromEmail(email) : "â€”";
      const palletBadge = (lastQuote.effectiveBand === "pallet")
        ? `<div class="mifsud-badge"><span class="dot"></span> PALLET SERVICE</div>`
        : ``;

      const actionLabel = lastQuote.isFixed ? "Use this service" : "Submit a quote";
      const sendDisabled = !(name && canEmail && address);

      const mailto = (name && canEmail && address)
        ? buildMailto({
            subject: lastQuote.isFixed ? "Courier Quote Confirmation" : "Courier Quote Request â€” Price on Request",
            customerId,
            name,
            email,
            address,
            quote: lastQuote
          })
        : "#";

      result.className = "result";
      result.classList.remove("hidden");

      result.innerHTML = `
        ${palletBadge}

        ${lastQuote.isFixed
          ? `<strong>Your shipping price is:</strong><div style="font-size:28px;font-weight:900;margin-top:6px;">${lastQuote.totalText}</div>`
          : `<strong>Price on request</strong>`}

        <div style="margin-top:10px;font-size:13px;line-height:1.35;text-align:left;color:rgba(0,0,0,.75)">
          <div><strong>Service Type:</strong> ${lastQuote.serviceType === "pallet" ? "Pallet Delivery" : "Package"}</div>
          <div><strong>Customer ID:</strong> ${customerId}</div>
          <div><strong>Customer:</strong> ${name || "â€”"}</div>
          <div><strong>E-mail:</strong> ${email || "â€”"}</div>
          <div>Ship from: <strong>Sicily</strong></div>
          <div>Ship to: <strong>${lastQuote.shipTo}</strong></div>
          <div><strong>Quantity:</strong> ${lastQuote.qty}</div>
          <div>Parcel Dimensions: ${lastQuote.dimsText}</div>
          <div>Size Category: ${lastQuote.sizeLabel}</div>
          <div>Weight: ${lastQuote.weight.toFixed(1)} kg</div>
          <div><strong>Delivery Address:</strong> ${address || "â€”"}</div>
        </div>

        <div class="confirm">
          <label for="agree">
            <input type="checkbox" id="agree" ${sendDisabled ? "disabled" : ""}>
            I agree to the above details and wish to use this service
          </label>
        </div>

        <button class="primary" id="send" type="button" disabled>${actionLabel}</button>
      `;

      // normalize fields
      addrEl.value = address;
      emailEl.value = email;

      const agree = document.getElementById("agree");
      const send = document.getElementById("send");

      function syncSend(){
        const ready = !sendDisabled && agree && agree.checked;
        send.disabled = !ready;
      }

      if(agree){
        agree.onchange = syncSend;
        syncSend();
      }

      

send.onclick = () => {
        if(send.disabled) return;

        const f = document.getElementById("formspreeForm");
        const successBox = document.getElementById("formSuccess");
        if(!f || !lastQuote) return;

        f.serviceType.value      = lastQuote.serviceType === "pallet" ? "Pallet Delivery" : "Package";
        f.customerId.value      = customerId;
        f.customerName.value    = name;
        f.customerEmail.value   = email;
        f.deliveryAddress.value = address;
        f.shipFrom.value        = "Sicily";
        f.shipTo.value          = lastQuote.shipTo;
        f.quantity.value        = lastQuote.qty;
        f.dimensions.value      = lastQuote.dimsText;
        f.sizeCategory.value    = lastQuote.sizeLabel;
        f.weight.value          = lastQuote.weight.toFixed(1) + " kg";
        f.totalPrice.value      = lastQuote.totalText;

        send.disabled = true;
        f.submit();

        // Show success message immediately (background submit)
        if(successBox){
          successBox.style.display = "block";
          send.textContent = "Sent âœ“";
        }
      };


    }

    // Live re-render final summary when contact fields change (step 3)
    [nameEl, emailEl, addrEl].forEach(el => {
      el.addEventListener("input", () => {
        // keep summary responsive, but don't show it before entering step 3
        if(step3.classList.contains("active")) renderFinalSummary();
      });
      el.addEventListener("change", () => {
        if(step3.classList.contains("active")) renderFinalSummary();
      });
    });
  })();
</script>

<script>
  // KPI accessibility: allow Enter/Space to "click" KPI cards
  document.addEventListener('keydown', function(e){
    const el = document.activeElement;
    if(!el || !el.classList || !el.classList.contains('mifsud-kpi')) return;
    if(e.key === 'Enter' || e.key === ' '){
      e.preventDefault();
      el.click();
    }
  });
</script>

<!-- Hidden Formspree form (embedded for background submission) -->
<form id="formspreeForm" action="https://formspree.io/f/xwvpnedj" method="POST" style="display:none;" target="formspree_iframe">
  <input type="hidden" name="serviceType">
  <input type="hidden" name="customerId">
  <input type="hidden" name="customerName">
  <input type="hidden" name="customerEmail">
  <input type="hidden" name="deliveryAddress">
  <input type="hidden" name="shipFrom">
  <input type="hidden" name="shipTo">
  <input type="hidden" name="quantity">
  <input type="hidden" name="dimensions">
  <input type="hidden" name="sizeCategory">
  <input type="hidden" name="weight">
  <input type="hidden" name="totalPrice">
</form>

<!-- Hidden iframe to prevent navigation on Formspree submit -->
<iframe name="formspree_iframe" style="display:none;"></iframe>

<!-- Success message -->
<div id="formSuccess" style="display:none; margin-top:16px; padding:14px; border-radius:12px;
     background:rgba(235,255,235,.95); border:1px solid rgba(40,150,40,.25);
     color:#1f6b1f; font-weight:700; text-align:center;">
  Thank you! Your shipping request has been sent successfully.<br>
  Weâ€™ll get back to you shortly.
</div>






